<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>ë‚˜ë§Œì˜ ì›¹ì†Œì„¤ ìŠ¤íŠœë””ì˜¤</title>

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- 2. ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- 3. React -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.292.0?external=react"
        }
      }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. ìŠ¤íƒ€ì¼ -->
    <style>
      /* Pretendard Variable */
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.css');
      /* Pretendard Static */
      @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css');
      /* Noto Sans KR */
      @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap');
      /* KoPub Batang */
      @import url('https://cdn.jsdelivr.net/npm/font-kopub@1.0/kopubbatang.min.css');
      /* KoPub World Batang */
      @import url('https://cdn.jsdelivr.net/npm/font-kopub@1.0/kopubworldbatang.min.css');

      /* ë§ì¤„ì„í‘œ(...) êµì •ìš© í°íŠ¸ */
      @font-face {
        font-family: 'EllipsisFix';
        src: url('https://cdn.jsdelivr.net/npm/font-kopub@1.0/fonts/KoPubBatangMedium.woff2')
          format('woff2');
        unicode-range: U+2026;
      }

      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 4px;
      }

      .novel-content p {
        margin-bottom: 0;
      }
      .novel-content hr {
        border: none;
        height: 1px;
        background-color: #a6a6a6;
        margin: 2em auto;
        width: 100px;
        display: block;
      }
      .novel-content blockquote {
        border: 1px solid #a6a6a6;
        padding: 1rem 1.25rem;
        margin: 1.5rem 0;
        width: 100%;
        box-sizing: border-box;
        background-color: transparent;
        text-indent: 0;
      }
      .novel-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 1em 0;
        table-layout: fixed;
      }
      .novel-content td,
      .novel-content th {
        border: 1px solid #a6a6a6;
        padding: 8px;
        word-break: break-word;
      }
      .novel-editor {
        outline: none;
        -webkit-tap-highlight-color: transparent;
      }
      .novel-editor:empty:before {
        content: 'ì—¬ê¸°ì— ì´ì•¼ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”...';
        color: gray;
        opacity: 0.5;
        pointer-events: none;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import {
        Settings,
        Edit3,
        BookOpen,
        X,
        RotateCcw,
        Save,
        AlignLeft,
        AlignCenter,
        AlignRight,
        ArrowUpDown,
        Palette,
        Bold,
        Italic,
        Minus,
        Quote,
        Table as TableIcon,
        PaintBucket,
        Check,
        Trash2,
        Download,
        MoreHorizontal,
        Type,
        Undo,
        Redo,
      } from 'lucide-react';

      // í°íŠ¸ CSS íŒŒì¼ URL ë§µí•‘
      const FONT_MAP = {
        'Pretendard Variable':
          'https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable-dynamic-subset.css',
        Pretendard:
          'https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard-dynamic-subset.css',
        'KoPub Batang':
          'https://cdn.jsdelivr.net/npm/font-kopub@1.0/kopubbatang.min.css',
        'KoPub World Batang':
          'https://cdn.jsdelivr.net/npm/font-kopub@1.0/kopubworldbatang.min.css',
        'Noto Sans KR':
          'https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap',
      };

      // í°íŠ¸ ë°ì´í„° ìºì‹œ
      const fontCache = new Map();

      // [í•µì‹¬] í°íŠ¸ ì„ë² ë”© ë¡œì§ (ìƒëŒ€ ê²½ë¡œ ë¬¸ì œ í•´ê²° ë²„ì „)
      async function prepareFontEmbedCSS(activeFontKey) {
        let mainFontKey = 'Pretendard Variable';
        if (
          activeFontKey.includes('Pretendard') &&
          !activeFontKey.includes('Variable')
        )
          mainFontKey = 'Pretendard';
        else if (activeFontKey.includes('KoPub Batang'))
          mainFontKey = 'KoPub Batang';
        else if (activeFontKey.includes('KoPub World Batang'))
          mainFontKey = 'KoPub World Batang';
        else if (activeFontKey.includes('Noto Sans'))
          mainFontKey = 'Noto Sans KR';

        if (fontCache.has(mainFontKey)) return fontCache.get(mainFontKey);

        try {
          const cssUrl = FONT_MAP[mainFontKey];
          if (!cssUrl) return null;

          // 1. CSS íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
          const cssRes = await fetch(cssUrl);
          let cssText = await cssRes.text();

          // 2. CSS ë‚´ì˜ í°íŠ¸ íŒŒì¼ URL ì¶”ì¶œ ë° ë³€í™˜
          const urlRegex = /url\(([^)]+)\)/g;
          let match;
          const replacements = [];

          while ((match = urlRegex.exec(cssText)) !== null) {
            let relativeUrl = match[1].replace(/['"]/g, '');
            // [ì¤‘ìš”] ìƒëŒ€ ê²½ë¡œë¥¼ ì ˆëŒ€ ê²½ë¡œë¡œ ë³€í™˜
            const absoluteUrl = new URL(relativeUrl, cssUrl).href;
            replacements.push({ original: match[0], url: absoluteUrl });
          }

          // 3. í°íŠ¸ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë° Base64 ë³€í™˜
          await Promise.all(
            replacements.map(async (item) => {
              try {
                const fontRes = await fetch(item.url);
                const fontBlob = await fontRes.blob();
                return new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onloadend = () => {
                    cssText = cssText.replace(
                      item.original,
                      `url(${reader.result})`,
                    );
                    resolve();
                  };
                  reader.onerror = reject;
                  reader.readAsDataURL(fontBlob);
                });
              } catch (e) {
                console.warn('Font file fetch failed:', item.url, e);
              }
            }),
          );

          // 4. ë§ì¤„ì„í‘œìš© EllipsisFix í°íŠ¸ ì¶”ê°€
          try {
            const ellipsisRes = await fetch(
              'https://cdn.jsdelivr.net/npm/font-kopub@1.0/fonts/KoPubBatangMedium.woff2',
            );
            const ellipsisBlob = await ellipsisRes.blob();
            const ellipsisBase64 = await new Promise((resolve) => {
              const reader = new FileReader();
              reader.onloadend = () => resolve(reader.result);
              reader.readAsDataURL(ellipsisBlob);
            });
            const ellipsisCss = `@font-face { font-family: 'EllipsisFix'; src: url('${ellipsisBase64}') format('woff2'); unicode-range: U+2026; }`;
            cssText += ellipsisCss;
          } catch (e) {}

          fontCache.set(mainFontKey, cssText);
          return cssText;
        } catch (e) {
          console.error('CSS parsing failed', e);
          return null;
        }
      }

      const WebNovelStudio = () => {
        const [isEditing, setIsEditing] = useState(true);
        const [showSettings, setShowSettings] = useState(false);
        const [resetConfirm, setResetConfirm] = useState(false);
        const [tableModal, setTableModal] = useState({
          show: false,
          rows: 3,
          cols: 3,
          widths: '33.3, 33.3, 33.3',
        });
        const [showClearModal, setShowClearModal] = useState(false);
        const editorRef = useRef(null);
        const savedRange = useRef(null);

        const defaultText = `<p style="text-align: center;">ì œ1ì¥. ì§„ì§œ ìµœì¢… í•´ê²°</p><p><br></p><p>ì´ì œ Pretendard í°íŠ¸ê°€ ì•ˆë“œë¡œì´ë“œì—ì„œë„ ê¹¨ì§€ì§€ ì•ŠìŠµë‹ˆë‹¤!</p><p><br></p><blockquote><strong>ì›ì¸ ë° í•´ê²°:</strong><br>í°íŠ¸ íŒŒì¼ ê²½ë¡œê°€ 'ìƒëŒ€ ê²½ë¡œ'ë¡œ ë˜ì–´ ìˆì–´ ì°¾ì§€ ëª»í•˜ë˜ ë¬¸ì œë¥¼ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.<br>ì´ì œ CSS íŒŒì¼ ìœ„ì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ<br>ì •í™•í•œ í°íŠ¸ íŒŒì¼ì„ ì°¾ì•„ë‚´ì–´ ì €ì¥í•©ë‹ˆë‹¤.</blockquote><p><br></p><p style="text-align: right;">- ê²½ë¡œ ì¶”ì  ë¡œì§ ì¶”ê°€ ì™„ë£Œ -</p>`;

        const [content, setContent] = useState(() => {
          try {
            const savedContent = localStorage.getItem('novel-content');
            if (!savedContent) return defaultText;
            if (!savedContent.trim().startsWith('<')) {
              return savedContent
                .split('\n')
                .map((line) => `<p>${line || '<br>'}</p>`)
                .join('');
            }
            return savedContent;
          } catch (e) {
            return defaultText;
          }
        });

        const defaultSettings = {
          bgColor: '#f7f7f7',
          textColor: '#333333',
          fontSize: 16,
          lineHeight: 1.6,
          letterSpacing: 0,
          fontWeight: 400,
          fontFamily: "'EllipsisFix', 'Pretendard Variable', sans-serif",
          useIndent: false,
          paragraphSpacing: 0,
        };

        const [settings, setSettings] = useState(() => {
          try {
            const savedSettings = localStorage.getItem('novel-settings');
            if (savedSettings) {
              return { ...defaultSettings, ...JSON.parse(savedSettings) };
            }
            return defaultSettings;
          } catch (e) {
            return defaultSettings;
          }
        });

        const [selectedColor, setSelectedColor] = useState('#e03131');

        useEffect(() => {
          document.execCommand('defaultParagraphSeparator', false, 'p');
        }, []);

        useEffect(() => {
          if (
            isEditing &&
            editorRef.current &&
            editorRef.current.innerHTML !== content
          ) {
            editorRef.current.innerHTML = content;
          }
        }, [isEditing]);

        useEffect(() => {
          try {
            localStorage.setItem('novel-content', content);
            localStorage.setItem('novel-settings', JSON.stringify(settings));
          } catch (e) {}
        }, [content, settings]);

        const handleSettingChange = (key, value) => {
          setSettings((prev) => ({ ...prev, [key]: value }));
        };

        const handleResetClick = () => {
          if (resetConfirm) {
            setSettings(defaultSettings);
            setResetConfirm(false);
          } else {
            setResetConfirm(true);
            setTimeout(() => setResetConfirm(false), 3000);
          }
        };

        const handleEditorBlur = () => {
          updateContentState();
          const selection = window.getSelection();
          if (selection.rangeCount > 0) {
            savedRange.current = selection.getRangeAt(0);
          }
        };

        const handleClearClick = () => {
          setShowClearModal(true);
        };

        const confirmClear = () => {
          const emptyContent = '<p><br></p>';
          setContent(emptyContent);
          if (editorRef.current) {
            editorRef.current.innerHTML = emptyContent;
            editorRef.current.focus();
          }
          setShowClearModal(false);
        };

        const handleSaveImage = async () => {
          const htmlToImageLib = window.htmlToImage;

          if (!htmlToImageLib) {
            alert('ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            return;
          }

          const node = document.querySelector('.novel-content');
          if (!node) return;

          document.body.style.cursor = 'wait';

          try {
            await document.fonts.ready;

            // [í•µì‹¬] ê°œì„ ëœ í°íŠ¸ ì„ë² ë”© (ìƒëŒ€ ê²½ë¡œ í•´ê²°)
            const fontEmbedCSS = await prepareFontEmbedCSS(settings.fontFamily);

            const scale = 3;
            const rootFontSize = parseFloat(
              getComputedStyle(document.documentElement).fontSize,
            );
            const paddingY = 1.3 * rootFontSize;
            const paddingX = 2 * rootFontSize;

            const originalWidth = node.offsetWidth;
            const originalHeight = node.offsetHeight;
            const totalWidth = originalWidth + paddingX * 2;
            const totalHeight = originalHeight + paddingY * 2;

            const options = {
              width: totalWidth * scale,
              height: totalHeight * scale,
              backgroundColor: settings.bgColor,
              fontEmbedCSS: fontEmbedCSS,
              style: {
                transform: `scale(${scale})`,
                transformOrigin: 'top left',
                padding: '1.3rem 2rem',
                backgroundColor: settings.bgColor,
                width: `${totalWidth}px`,
                height: `${totalHeight}px`,
                boxSizing: 'border-box',
                margin: 0,
                fontFamily: settings.fontFamily,
              },
              cacheBust: true,
            };

            const dataUrl = await htmlToImageLib.toPng(node, options);
            const res = await fetch(dataUrl);
            const blob = await res.blob();

            const isIOS =
              /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

            if (isIOS && navigator.share) {
              const file = new File([blob], `novel-${Date.now()}.png`, {
                type: 'image/png',
              });
              try {
                await navigator.share({ files: [file] });
              } catch (err) {
                console.log('Share failed', err);
              }
            } else {
              const url = URL.createObjectURL(blob);
              const link = document.createElement('a');
              link.download = `novel-${Date.now()}.png`;
              link.href = url;
              link.click();
              URL.revokeObjectURL(url);
            }

            document.body.style.cursor = 'default';
          } catch (e) {
            console.error(e);
            alert('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            document.body.style.cursor = 'default';
          }
        };

        const applyCommand = (command, value = null) => {
          const scrollX = window.scrollX;
          const scrollY = window.scrollY;

          if (savedRange.current) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange.current);
          }

          document.execCommand('styleWithCSS', false, true);
          document.execCommand(command, false, value);

          window.scrollTo(scrollX, scrollY);
          updateContentState();
        };

        const insertDivider = () => {
          applyCommand('insertHorizontalRule');
        };
        const insertQuote = () => {
          applyCommand('formatBlock', 'blockquote');
        };
        const insertEllipsis = () => {
          applyCommand('insertText', 'â€¦');
        };

        const openTableModal = () => {
          const cols = 3;
          const defaultWidth = (100 / cols).toFixed(1);
          const widths = Array(cols).fill(defaultWidth).join(', ');
          setTableModal({ show: true, rows: 3, cols: 3, widths });
        };

        const handleColChange = (newCols) => {
          const safeCols = Math.max(1, parseInt(newCols) || 1);
          const defaultWidth = (100 / safeCols).toFixed(1);
          const widths = Array(safeCols).fill(defaultWidth).join(', ');
          setTableModal({ ...tableModal, cols: safeCols, widths });
        };

        const insertTable = () => {
          const { rows, cols, widths } = tableModal;
          let widthList = widths.split(',').map((w) => parseFloat(w.trim()));
          if (widthList.length !== cols) {
            const defaultW = (100 / cols).toFixed(1);
            widthList = Array(cols).fill(defaultW);
          }

          let tableHTML =
            '<table style="width: 100%; border-collapse: collapse; margin: 1em 0; table-layout: fixed;"><tbody>';
          for (let i = 0; i < rows; i++) {
            tableHTML += '<tr>';
            for (let j = 0; j < cols; j++) {
              const widthStyle = `width: ${widthList[j] || 100 / cols}%;`;
              tableHTML += `<td style="border: 1px solid #A6A6A6; padding: 8px; ${widthStyle} word-break: break-word;">&nbsp;</td>`;
            }
            tableHTML += '</tr>';
          }
          tableHTML += '</tbody></table><p><br></p>';

          setTableModal({ ...tableModal, show: false });

          if (savedRange.current) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange.current);
          }

          document.execCommand('insertHTML', false, tableHTML);
          updateContentState();
        };

        const applyCellBackground = () => {
          if (savedRange.current) {
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(savedRange.current);
          }

          const selection = window.getSelection();
          if (!selection.rangeCount) return;

          let node = selection.anchorNode;
          while (node && node !== editorRef.current) {
            if (node.nodeName === 'TD' || node.nodeName === 'TH') {
              node.style.backgroundColor = selectedColor;
              updateContentState();
              return;
            }
            node = node.parentNode;
          }
          alert('í‘œì˜ ì¹¸(Cell) ì•ˆì— ì»¤ì„œë¥¼ ë‘ê³  ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
        };

        const handleKeyDown = (e) => {
          if (e.key === 'Enter' && !e.shiftKey) {
            const selection = window.getSelection();
            if (selection.rangeCount) {
              let currentNode = selection.anchorNode;
              while (currentNode && currentNode !== editorRef.current) {
                if (currentNode.nodeName === 'BLOCKQUOTE') {
                  e.preventDefault();
                  document.execCommand('insertLineBreak');
                  updateContentState();
                  return;
                }
                currentNode = currentNode.parentNode;
              }
            }
          }

          if (e.key === ' ' || e.key === 'Enter') {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
              const range = selection.getRangeAt(0);
              const textNode = range.startContainer;

              if (textNode.nodeType === 3) {
                const text = textNode.textContent;
                const offset = range.startOffset;

                if (offset >= 3 && text.slice(offset - 3, offset) === '...') {
                  const newText =
                    text.slice(0, offset - 3) + 'â€¦' + text.slice(offset);
                  textNode.textContent = newText;
                  range.setStart(textNode, offset - 2);
                  range.setEnd(textNode, offset - 2);
                  selection.removeAllRanges();
                  selection.addRange(range);
                  updateContentState();
                }
              }
            }
          }
        };

        const updateContentState = () => {
          if (editorRef.current) setContent(editorRef.current.innerHTML);
        };

        const fontOptions = [
          {
            name: 'Pretendard Variable',
            value: "'EllipsisFix', 'Pretendard Variable', sans-serif",
          },
          {
            name: 'Pretendard',
            value: "'EllipsisFix', 'Pretendard', sans-serif",
          },
          { name: 'KoPub ë°”íƒ•', value: "'KoPub Batang', serif" },
          { name: 'KoPub World ë°”íƒ•', value: "'KoPub World Batang', serif" },
          { name: 'Noto Sans', value: "'Noto Sans KR', sans-serif" },
        ];

        return (
          <div
            className="min-h-screen transition-colors duration-300 ease-in-out relative overflow-hidden flex flex-col"
            style={{
              backgroundColor: settings.bgColor,
              color: settings.textColor,
              fontFamily: settings.fontFamily,
              fontWeight: settings.fontWeight,
            }}
          >
            <header
              className="fixed top-0 left-0 right-0 z-50 transition-all duration-300 bg-opacity-95 backdrop-blur-md border-b border-black/5"
              style={{ backgroundColor: settings.bgColor }}
            >
              <div className="flex justify-between items-center px-4 py-2">
                <h1 className="text-lg font-bold opacity-80 flex items-center gap-2">
                  ğŸ“–
                </h1>
                <button
                  onClick={() => setShowSettings(!showSettings)}
                  className="p-2 rounded-full hover:bg-black/5 transition-colors"
                >
                  <Settings size={24} />
                </button>
              </div>

              {isEditing && (
                <div className="border-t border-black/5 px-2 py-2 overflow-x-auto no-scrollbar">
                  <div className="flex items-center gap-2 min-w-max px-2">
                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5 mr-2">
                      <button
                        onClick={() => applyCommand('undo')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ë˜ëŒë¦¬ê¸°"
                      >
                        <Undo size={18} />
                      </button>
                      <button
                        onClick={() => applyCommand('redo')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ë‹¤ì‹œ ì‹¤í–‰"
                      >
                        <Redo size={18} />
                      </button>
                    </div>

                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5 mr-2">
                      <Type size={16} className="text-gray-500 ml-2 mr-1" />
                      <select
                        onChange={(e) => {
                          applyCommand('fontName', e.target.value);
                          e.target.value = '';
                        }}
                        className="bg-transparent text-xs p-1 outline-none w-32 cursor-pointer"
                        defaultValue=""
                      >
                        <option value="" disabled>
                          í°íŠ¸ ë³€ê²½
                        </option>
                        {fontOptions.map((opt) => (
                          <option key={opt.value} value={opt.value}>
                            {opt.name}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5">
                      <button
                        onClick={() => applyCommand('justifyLeft')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ì™¼ìª½"
                      >
                        <AlignLeft size={18} />
                      </button>
                      <button
                        onClick={() => applyCommand('justifyCenter')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ê°€ìš´ë°"
                      >
                        <AlignCenter size={18} />
                      </button>
                      <button
                        onClick={() => applyCommand('justifyRight')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ì˜¤ë¥¸ìª½"
                      >
                        <AlignRight size={18} />
                      </button>
                    </div>
                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5">
                      <button
                        onClick={() => applyCommand('bold')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="êµµê²Œ"
                      >
                        <Bold size={18} />
                      </button>
                      <button
                        onClick={() => applyCommand('italic')}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ê¸°ìš¸ì„"
                      >
                        <Italic size={18} />
                      </button>
                    </div>
                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5">
                      <button
                        onClick={insertDivider}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="êµ¬ë¶„ì„ "
                      >
                        <Minus size={18} />
                      </button>
                      <button
                        onClick={insertQuote}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ì¸ìš©êµ¬"
                      >
                        <Quote size={18} />
                      </button>
                      <button
                        onClick={insertEllipsis}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="ë§ì¤„ì„í‘œ (â€¦)"
                      >
                        <MoreHorizontal size={18} />
                      </button>
                      <button
                        onClick={openTableModal}
                        className="p-1.5 hover:bg-black/10 rounded"
                        title="í‘œ ì‚½ì…"
                      >
                        <TableIcon size={18} />
                      </button>
                    </div>
                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5 pl-2 pr-1">
                      <div className="relative w-5 h-5 mr-2">
                        <div
                          className="w-full h-full rounded border border-gray-300 shadow-sm"
                          style={{ backgroundColor: selectedColor }}
                        />
                        <input
                          type="color"
                          value={selectedColor}
                          onChange={(e) => setSelectedColor(e.target.value)}
                          className="absolute inset-0 opacity-0 cursor-pointer"
                        />
                      </div>
                      <input
                        type="text"
                        value={selectedColor}
                        onChange={(e) => setSelectedColor(e.target.value)}
                        className="w-16 text-xs p-1 border border-gray-300 rounded focus:ring-1 focus:ring-indigo-500 outline-none uppercase font-mono bg-transparent"
                        placeholder="#000000"
                        maxLength={7}
                      />
                      <button
                        onClick={() => applyCommand('foreColor', selectedColor)}
                        className="ml-1 p-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 rounded transition-colors"
                        title="ê¸€ììƒ‰"
                      >
                        <Check size={14} strokeWidth={3} />
                      </button>
                      <button
                        onClick={applyCellBackground}
                        className="ml-1 p-1 bg-yellow-50 hover:bg-yellow-100 text-yellow-600 rounded transition-colors"
                        title="ë°°ê²½ìƒ‰"
                      >
                        <PaintBucket size={14} strokeWidth={3} />
                      </button>
                    </div>
                    <div className="flex items-center bg-white/50 rounded-lg p-1 border border-black/5">
                      <button
                        onClick={handleClearClick}
                        className="p-1.5 hover:bg-red-100 text-red-600 rounded"
                        title="ì „ì²´ ì‚­ì œ"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </header>

            <main
              className={`${
                isEditing ? 'pt-36 sm:pt-32' : 'pt-20'
              } pb-24 px-3 max-w-3xl mx-auto w-full flex-grow`}
            >
              <div
                className="novel-content mt-8 break-words outline-none"
                style={{
                  fontSize: `${settings.fontSize}px`,
                  lineHeight: settings.lineHeight,
                  letterSpacing: `${settings.letterSpacing}px`,
                  fontWeight: settings.fontWeight,
                }}
              >
                {isEditing ? (
                  <div
                    ref={editorRef}
                    className="novel-editor"
                    contentEditable={true}
                    suppressContentEditableWarning={true}
                    onKeyDown={handleKeyDown}
                    onInput={updateContentState}
                    onBlur={handleEditorBlur}
                    spellCheck="false"
                    style={{ color: settings.textColor }}
                  />
                ) : (
                  <div
                    dangerouslySetInnerHTML={{ __html: content }}
                    style={{ pointerEvents: 'none' }}
                  />
                )}
              </div>
            </main>

            {tableModal.show && (
              <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs font-sans text-gray-800">
                  <h3 className="text-lg font-bold mb-4">í‘œ ë§Œë“¤ê¸°</h3>
                  <div className="flex gap-4 mb-4">
                    <div className="flex-1">
                      <label className="block text-xs text-gray-500 mb-1 font-bold">
                        í–‰(Row)
                      </label>
                      <input
                        type="number"
                        min="1"
                        max="20"
                        value={tableModal.rows}
                        onChange={(e) =>
                          setTableModal({
                            ...tableModal,
                            rows: parseInt(e.target.value) || 1,
                          })
                        }
                        className="w-full border rounded p-2 text-center focus:ring-2 focus:ring-indigo-500 outline-none"
                      />
                    </div>
                    <div className="flex-1">
                      <label className="block text-xs text-gray-500 mb-1 font-bold">
                        ì—´(Column)
                      </label>
                      <input
                        type="number"
                        min="1"
                        max="10"
                        value={tableModal.cols}
                        onChange={(e) => handleColChange(e.target.value)}
                        className="w-full border rounded p-2 text-center focus:ring-2 focus:ring-indigo-500 outline-none"
                      />
                    </div>
                  </div>
                  <div className="mb-6">
                    <label className="block text-xs text-gray-500 mb-1 font-bold">
                      ì—´ ë„ˆë¹„ (%) - ì‰¼í‘œë¡œ êµ¬ë¶„
                    </label>
                    <input
                      type="text"
                      value={tableModal.widths}
                      onChange={(e) =>
                        setTableModal({ ...tableModal, widths: e.target.value })
                      }
                      className="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                    />
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() =>
                        setTableModal({ ...tableModal, show: false })
                      }
                      className="flex-1 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors font-medium"
                    >
                      ì·¨ì†Œ
                    </button>
                    <button
                      onClick={insertTable}
                      className="flex-1 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors flex justify-center items-center gap-1 font-medium"
                    >
                      <Check size={16} /> ìƒì„±
                    </button>
                  </div>
                </div>
              </div>
            )}

            {showClearModal && (
              <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-xs font-sans text-gray-800">
                  <h3 className="text-lg font-bold mb-2">ì „ì²´ ì‚­ì œ</h3>
                  <p className="text-sm text-gray-600 mb-6">
                    ì‘ì„±ëœ ëª¨ë“  ë‚´ìš©ì´ ì‚­ì œë©ë‹ˆë‹¤.
                    <br />
                    ì •ë§ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                  </p>
                  <div className="flex gap-2">
                    <button
                      onClick={() => setShowClearModal(false)}
                      className="flex-1 py-2 bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors font-medium"
                    >
                      ì·¨ì†Œ
                    </button>
                    <button
                      onClick={confirmClear}
                      className="flex-1 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors font-medium"
                    >
                      ì‚­ì œ
                    </button>
                  </div>
                </div>
              </div>
            )}

            <div
              className={`fixed inset-y-0 right-0 w-80 bg-white transform transition-transform duration-300 z-50 overflow-y-auto ${
                showSettings ? 'translate-x-0 shadow-2xl' : 'translate-x-full'
              }`}
              style={{
                color: '#333',
                fontFamily: "'Noto Sans KR', sans-serif",
              }}
            >
              <div className="p-6">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-bold">ë·°ì–´ ì„¤ì •</h2>
                  <button
                    onClick={() => setShowSettings(false)}
                    className="p-1 hover:bg-gray-100 rounded"
                  >
                    <X size={24} />
                  </button>
                </div>
                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      ê¸€ê¼´
                    </label>
                    <select
                      value={settings.fontFamily}
                      onChange={(e) =>
                        handleSettingChange('fontFamily', e.target.value)
                      }
                      className="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 outline-none"
                    >
                      {fontOptions.map((opt) => (
                        <option key={opt.value} value={opt.value}>
                          {opt.name}
                        </option>
                      ))}
                    </select>
                  </div>
                  <div className="bg-gray-50 p-3 rounded-lg border border-gray-200 space-y-4">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-2">
                        <AlignLeft size={16} className="text-gray-500" />
                        <label className="text-sm font-medium text-gray-700">
                          ë¬¸ë‹¨ ì²« ì¤„ ë“¤ì—¬ì“°ê¸°
                        </label>
                      </div>
                      <input
                        type="checkbox"
                        checked={settings.useIndent}
                        onChange={(e) =>
                          handleSettingChange('useIndent', e.target.checked)
                        }
                        className="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500 cursor-pointer"
                      />
                    </div>
                    <div>
                      <div className="flex items-center gap-2 mb-2">
                        <ArrowUpDown size={16} className="text-gray-500" />
                        <label className="text-sm font-medium text-gray-700">
                          ë¬¸ë‹¨ ê°„ê²©
                        </label>
                      </div>
                      <div className="flex gap-2">
                        {[
                          { label: 'ì—†ìŒ', value: 0 },
                          { label: '0.5ì¤„', value: 0.5 },
                          { label: '1ì¤„', value: 1.0 },
                        ].map((opt) => (
                          <button
                            key={opt.label}
                            onClick={() =>
                              handleSettingChange('paragraphSpacing', opt.value)
                            }
                            className={`flex-1 py-1 px-2 text-xs rounded border transition-colors ${
                              settings.paragraphSpacing === opt.value
                                ? 'bg-indigo-600 text-white border-indigo-600'
                                : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'
                            }`}
                          >
                            {opt.label}
                          </button>
                        ))}
                      </div>
                    </div>
                  </div>
                  {[
                    {
                      label: 'ê¸€ì êµµê¸°',
                      key: 'fontWeight',
                      min: 100,
                      max: 900,
                      step: 50,
                    },
                    {
                      label: 'ê¸€ì í¬ê¸°',
                      key: 'fontSize',
                      min: 12,
                      max: 32,
                      step: 0.5,
                    },
                    {
                      label: 'ì¤„ ê°„ê²©',
                      key: 'lineHeight',
                      min: 1.0,
                      max: 3.0,
                      step: 0.05,
                    },
                    {
                      label: 'ê¸€ì ê°„ê²©',
                      key: 'letterSpacing',
                      min: -2,
                      max: 10,
                      step: 0.1,
                    },
                  ].map((item) => (
                    <div key={item.key}>
                      <div className="flex justify-between mb-2">
                        <label className="text-sm font-medium text-gray-700">
                          {item.label}
                        </label>
                        <span className="text-xs text-gray-500">
                          {settings[item.key]}
                        </span>
                      </div>
                      <input
                        type="range"
                        min={item.min}
                        max={item.max}
                        step={item.step}
                        value={settings[item.key]}
                        onChange={(e) =>
                          handleSettingChange(item.key, Number(e.target.value))
                        }
                        className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      />
                    </div>
                  ))}
                  <hr className="border-gray-200" />
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        ë°°ê²½ ìƒ‰ìƒ
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="color"
                          value={settings.bgColor}
                          onChange={(e) =>
                            handleSettingChange('bgColor', e.target.value)
                          }
                          className="w-8 h-8 rounded border overflow-hidden cursor-pointer p-0"
                        />
                        <input
                          type="text"
                          value={settings.bgColor}
                          onChange={(e) =>
                            handleSettingChange('bgColor', e.target.value)
                          }
                          className="w-20 text-xs p-1 border border-gray-300 rounded outline-none uppercase font-mono"
                          maxLength={7}
                        />
                      </div>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">
                        ê¸€ì ìƒ‰ìƒ
                      </label>
                      <div className="flex items-center gap-2">
                        <input
                          type="color"
                          value={settings.textColor}
                          onChange={(e) =>
                            handleSettingChange('textColor', e.target.value)
                          }
                          className="w-8 h-8 rounded border overflow-hidden cursor-pointer p-0"
                        />
                        <input
                          type="text"
                          value={settings.textColor}
                          onChange={(e) =>
                            handleSettingChange('textColor', e.target.value)
                          }
                          className="w-20 text-xs p-1 border border-gray-300 rounded outline-none uppercase font-mono"
                          maxLength={7}
                        />
                      </div>
                    </div>
                  </div>
                  <div className="space-y-2 mt-6">
                    <button
                      onClick={handleSaveImage}
                      className="w-full py-3 px-4 flex items-center justify-center gap-2 rounded-lg transition-colors text-sm font-bold bg-indigo-600 text-white hover:bg-indigo-700 shadow-md"
                    >
                      <Download size={18} /> ì´ë¯¸ì§€ë¡œ ì €ì¥
                    </button>
                    <button
                      onClick={handleResetClick}
                      className={`w-full py-2 px-4 flex items-center justify-center gap-2 rounded-lg transition-colors text-sm font-medium ${
                        resetConfirm
                          ? 'bg-red-100 text-red-700 hover:bg-red-200'
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}
                    >
                      <RotateCcw size={16} />{' '}
                      {resetConfirm ? 'ì •ë§ ì´ˆê¸°í™”í• ê¹Œìš”?' : 'ì„¤ì • ì´ˆê¸°í™”'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
            {showSettings && (
              <div
                className="fixed inset-0 bg-black/20 z-40"
                onClick={() => setShowSettings(false)}
              />
            )}
            <div className="fixed bottom-8 right-8 z-30">
              <button
                onClick={() => {
                  updateContentState();
                  setIsEditing(!isEditing);
                }}
                className={`flex items-center gap-2 px-6 py-3 rounded-full shadow-lg transform transition-all hover:scale-105 active:scale-95 font-bold ${
                  isEditing
                    ? 'bg-indigo-600 text-white hover:bg-indigo-700'
                    : 'bg-emerald-600 text-white hover:bg-emerald-700'
                }`}
              >
                {isEditing ? (
                  <>
                    <BookOpen size={20} />
                    ì½ê¸° ëª¨ë“œ
                  </>
                ) : (
                  <>
                    <Edit3 size={20} />
                    ìˆ˜ì • ëª¨ë“œ
                  </>
                )}
              </button>
            </div>
            <div
              className="fixed bottom-8 left-8 text-xs opacity-40 pointer-events-none flex items-center gap-1"
              style={{ color: settings.textColor }}
            >
              <Save size={12} /> ìë™ ì €ì¥ë¨
            </div>
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<WebNovelStudio />);
    </script>
  </body>
</html>
